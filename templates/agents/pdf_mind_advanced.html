{% extends "base.html" %}

{% block title %}PDFMind - Advanced Document Intelligence{% endblock %}

{% block extra_css %}
<style>
    /* Modern Variables */
    :root {
        --pdf-primary: #10b981;
        --pdf-secondary: #059669;
        --pdf-accent: #34d399;
        --pdf-bg-glass: rgba(16, 185, 129, 0.1);
        --pdf-border: rgba(16, 185, 129, 0.2);
        --pdf-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
    }

    .pdf-container {
        min-height: 100vh;
        background: linear-gradient(135deg, 
            rgba(16, 185, 129, 0.05) 0%, 
            rgba(5, 150, 105, 0.05) 50%,
            rgba(52, 211, 153, 0.05) 100%);
        padding: 2rem 0;
    }

    .chat-interface {
        max-width: 1400px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 300px 1fr 350px;
        gap: 2rem;
        padding: 0 2rem;
        height: calc(100vh - 140px);
    }

    /* Document Panel */
    .document-panel {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--pdf-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        background: linear-gradient(135deg, var(--pdf-primary), var(--pdf-secondary));
        padding: 1rem 1.5rem;
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .documents-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .document-item {
        background: var(--pdf-bg-glass);
        border: 1px solid var(--pdf-border);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .document-item:hover {
        background: var(--pdf-primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--pdf-shadow);
    }

    .document-item.active {
        background: var(--pdf-primary);
        color: white;
        border-color: var(--pdf-primary);
    }

    .doc-name {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .doc-info {
        font-size: 0.85rem;
        opacity: 0.8;
        display: flex;
        justify-content: space-between;
    }

    .upload-zone {
        border: 2px dashed var(--pdf-border);
        border-radius: 12px;
        padding: 2rem 1rem;
        text-align: center;
        margin: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: var(--pdf-primary);
        background: var(--pdf-bg-glass);
    }

    /* Main Chat Area */
    .chat-main {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--pdf-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    .chat-header {
        background: linear-gradient(135deg, var(--pdf-primary), var(--pdf-secondary));
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: white;
    }

    .agent-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .agent-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .agent-status {
        display: flex;
        flex-direction: column;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #34d399;
        animation: pulse 2s infinite;
    }

    .chat-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    /* Messages Area */
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        display: flex;
        gap: 1rem;
        max-width: 85%;
        animation: messageSlide 0.3s ease-out;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        color: white;
        flex-shrink: 0;
    }

    .message.ai .message-avatar {
        background: linear-gradient(135deg, var(--pdf-primary), var(--pdf-secondary));
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, var(--purple-primary), var(--blue-accent));
    }

    .message-bubble {
        background: var(--pdf-bg-glass);
        border: 1px solid var(--pdf-border);
        border-radius: 18px;
        padding: 1rem 1.5rem;
        position: relative;
        max-width: 100%;
        word-wrap: break-word;
    }

    .message.user .message-bubble {
        background: linear-gradient(135deg, var(--pdf-primary), var(--pdf-secondary));
        color: white;
        border: none;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.6;
        margin-top: 0.5rem;
    }

    .source-citation {
        background: rgba(16, 185, 129, 0.05);
        border: 1px solid var(--pdf-border);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }

    .citation-header {
        font-weight: 600;
        color: var(--pdf-primary);
        margin-bottom: 0.25rem;
    }

    /* Analysis Results */
    .analysis-result {
        background: var(--pdf-bg-glass);
        border: 1px solid var(--pdf-border);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .analysis-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: var(--pdf-primary);
        margin-bottom: 0.75rem;
    }

    .analysis-content {
        color: var(--text-primary);
        line-height: 1.5;
    }

    .highlight-text {
        background: rgba(16, 185, 129, 0.2);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 500;
    }

    /* Input Area */
    .chat-input-area {
        padding: 1.5rem;
        border-top: 1px solid var(--pdf-border);
        background: rgba(16, 185, 129, 0.02);
    }

    .input-container {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .input-group {
        flex: 1;
        position: relative;
    }

    .chat-input {
        width: 100%;
        min-height: 50px;
        max-height: 150px;
        padding: 1rem 3rem 1rem 1.5rem;
        border: 2px solid var(--pdf-border);
        border-radius: 25px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 1rem;
        resize: none;
        outline: none;
        transition: all 0.3s ease;
    }

    .chat-input:focus {
        border-color: var(--pdf-primary);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
    }

    .input-actions {
        position: absolute;
        right: 1rem;
        bottom: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .input-btn {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background: var(--pdf-bg-glass);
        color: var(--pdf-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .input-btn:hover {
        background: var(--pdf-primary);
        color: white;
        transform: scale(1.1);
    }

    .send-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--pdf-primary), var(--pdf-secondary));
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }

    .send-btn:hover {
        transform: scale(1.1);
        box-shadow: var(--pdf-shadow);
    }

    /* Sidebar */
    .chat-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .sidebar-panel {
        background: var(--card-bg);
        border: 1px solid var(--pdf-border);
        border-radius: 20px;
        overflow: hidden;
    }

    .panel-content {
        padding: 1.5rem;
    }

    /* Query Templates */
    .query-templates {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .query-btn {
        background: var(--pdf-bg-glass);
        border: 1px solid var(--pdf-border);
        border-radius: 12px;
        padding: 1rem;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--text-primary);
    }

    .query-btn:hover {
        background: var(--pdf-primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .query-btn strong {
        display: block;
        margin-bottom: 0.25rem;
    }

    .query-btn span {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    /* Analysis Tools */
    .analysis-tools {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .tool-btn {
        background: var(--pdf-bg-glass);
        border: 1px solid var(--pdf-border);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--text-primary);
        text-decoration: none;
    }

    .tool-btn:hover {
        background: var(--pdf-primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .tool-btn i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    /* Settings */
    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--pdf-border);
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-toggle {
        width: 50px;
        height: 25px;
        background: #374151;
        border-radius: 15px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .setting-toggle.active {
        background: var(--pdf-primary);
    }

    .setting-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 21px;
        height: 21px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .setting-toggle.active::after {
        left: 27px;
    }

    /* Progress bars */
    .progress-bar {
        background: rgba(16, 185, 129, 0.1);
        border-radius: 10px;
        height: 8px;
        margin: 0.5rem 0;
        overflow: hidden;
    }

    .progress-fill {
        background: linear-gradient(135deg, var(--pdf-primary), var(--pdf-secondary));
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .chat-interface {
            grid-template-columns: 250px 1fr 300px;
        }
    }

    @media (max-width: 968px) {
        .chat-interface {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .document-panel,
        .chat-sidebar {
            order: -1;
        }
        
        .analysis-tools {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* Animations */
    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pdf-container">
    <div class="chat-interface">
        <!-- Document Panel -->
        <div class="document-panel">
            <div class="panel-header">
                <i class="fas fa-file-pdf"></i>
                Documents
            </div>
            
            <div class="upload-zone" onclick="document.getElementById('pdfInput').click()">
                <input type="file" id="pdfInput" style="display: none;" multiple accept=".pdf,.doc,.docx,.txt" onchange="handleDocumentUpload(event)">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--pdf-primary); margin-bottom: 0.5rem;"></i>
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Upload Documents</div>
                <div style="font-size: 0.85rem; opacity: 0.7;">PDF, DOC, DOCX, TXT</div>
            </div>

            <div class="documents-list" id="documentsList">
                <div class="document-item active" onclick="selectDocument(this, 'sample')">
                    <div class="doc-name">
                        <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
                        Sample Research Paper
                    </div>
                    <div class="doc-info">
                        <span>127 pages</span>
                        <span>2.3 MB</span>
                    </div>
                </div>
                
                <div class="document-item" onclick="selectDocument(this, 'manual')">
                    <div class="doc-name">
                        <i class="fas fa-file-alt" style="color: #3b82f6;"></i>
                        User Manual
                    </div>
                    <div class="doc-info">
                        <span>45 pages</span>
                        <span>1.1 MB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="agent-info">
                    <div class="agent-avatar">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="agent-status">
                        <h2 style="margin: 0; font-size: 1.2rem;">PDFMind</h2>
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            <span>Analyzing documents</span>
                        </div>
                    </div>
                </div>
                <div class="chat-controls">
                    <button class="control-btn" onclick="toggleAnalysisMode()" title="Analysis Mode">
                        <i class="fas fa-microscope" id="analysisIcon"></i>
                    </button>
                    <button class="control-btn" onclick="exportAnalysis()" title="Export Analysis">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="control-btn" onclick="clearChat()" title="Clear Chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <div class="message ai">
                    <div class="message-avatar">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            Hello! I'm PDFMind, your advanced document intelligence assistant. I've analyzed your uploaded documents and I'm ready to help you extract insights, answer questions, and understand complex information. What would you like to know about your documents?
                        </div>
                        <div class="analysis-result">
                            <div class="analysis-header">
                                <i class="fas fa-chart-bar"></i>
                                Document Analysis Complete
                            </div>
                            <div class="analysis-content">
                                • <span class="highlight-text">Sample Research Paper</span>: 127 pages analyzed, 15 key topics identified<br>
                                • <span class="highlight-text">User Manual</span>: 45 pages processed, 8 main sections categorized<br>
                                • Total processing time: 0.3 seconds
                            </div>
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
            </div>

            <!-- Chat Input Area -->
            <div class="chat-input-area">
                <div class="input-container">
                    <div class="input-group">
                        <textarea 
                            id="messageInput" 
                            class="chat-input" 
                            placeholder="Ask me anything about your documents..."
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-btn" onclick="openAdvancedQuery()" title="Advanced Query">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="input-btn" onclick="insertCitation()" title="Insert Citation">
                                <i class="fas fa-quote-right"></i>
                            </button>
                        </div>
                    </div>
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="chat-sidebar">
            <!-- Query Templates -->
            <div class="sidebar-panel">
                <div class="panel-header">
                    <i class="fas fa-question-circle"></i>
                    Smart Questions
                </div>
                <div class="panel-content">
                    <div class="query-templates">
                        <button class="query-btn" onclick="sendQuery('What are the main findings and conclusions?')">
                            <strong>📊 Main Findings</strong>
                            <span>Extract key results and conclusions</span>
                        </button>
                        <button class="query-btn" onclick="sendQuery('Summarize this document in 3 key points')">
                            <strong>📝 Executive Summary</strong>
                            <span>Get a concise overview</span>
                        </button>
                        <button class="query-btn" onclick="sendQuery('What methodology was used?')">
                            <strong>🔬 Methodology</strong>
                            <span>Understand research methods</span>
                        </button>
                        <button class="query-btn" onclick="sendQuery('Extract all data tables and figures')">
                            <strong>📈 Data Extraction</strong>
                            <span>Find tables, charts, and data</span>
                        </button>
                        <button class="query-btn" onclick="sendQuery('What are the limitations mentioned?')">
                            <strong>⚠️ Limitations</strong>
                            <span>Identify constraints and caveats</span>
                        </button>
                        <button class="query-btn" onclick="sendQuery('Compare with previous research')">
                            <strong>🔄 Comparison</strong>
                            <span>Analyze relationships</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Tools -->
            <div class="sidebar-panel">
                <div class="panel-header">
                    <i class="fas fa-tools"></i>
                    Analysis Tools
                </div>
                <div class="panel-content">
                    <div class="analysis-tools">
                        <button class="tool-btn" onclick="runAnalysis('sentiment')">
                            <i class="fas fa-smile"></i>
                            <span>Sentiment</span>
                        </button>
                        <button class="tool-btn" onclick="runAnalysis('keywords')">
                            <i class="fas fa-tags"></i>
                            <span>Keywords</span>
                        </button>
                        <button class="tool-btn" onclick="runAnalysis('entities')">
                            <i class="fas fa-user-tag"></i>
                            <span>Entities</span>
                        </button>
                        <button class="tool-btn" onclick="runAnalysis('topics')">
                            <i class="fas fa-sitemap"></i>
                            <span>Topics</span>
                        </button>
                        <button class="tool-btn" onclick="runAnalysis('readability')">
                            <i class="fas fa-eye"></i>
                            <span>Readability</span>
                        </button>
                        <button class="tool-btn" onclick="runAnalysis('summary')">
                            <i class="fas fa-compress-alt"></i>
                            <span>Summary</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Document Stats -->
            <div class="sidebar-panel">
                <div class="panel-header">
                    <i class="fas fa-chart-line"></i>
                    Document Stats
                </div>
                <div class="panel-content">
                    <div class="setting-item">
                        <span>Total Pages</span>
                        <strong style="color: var(--pdf-primary);">172</strong>
                    </div>
                    <div class="setting-item">
                        <span>Word Count</span>
                        <strong style="color: var(--pdf-primary);">45,230</strong>
                    </div>
                    <div class="setting-item">
                        <span>Tables Found</span>
                        <strong style="color: var(--pdf-primary);">23</strong>
                    </div>
                    <div class="setting-item">
                        <span>Images/Figures</span>
                        <strong style="color: var(--pdf-primary);">18</strong>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Analysis Progress</span>
                            <span style="color: var(--pdf-primary);">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="sidebar-panel">
                <div class="panel-header">
                    <i class="fas fa-cog"></i>
                    Settings
                </div>
                <div class="panel-content">
                    <div class="setting-item">
                        <span>Source Citations</span>
                        <div class="setting-toggle active" onclick="toggleSetting(this)"></div>
                    </div>
                    <div class="setting-item">
                        <span>Deep Analysis</span>
                        <div class="setting-toggle active" onclick="toggleSetting(this)"></div>
                    </div>
                    <div class="setting-item">
                        <span>Multi-Doc Search</span>
                        <div class="setting-toggle active" onclick="toggleSetting(this)"></div>
                    </div>
                    <div class="setting-item">
                        <span>Auto-Summarize</span>
                        <div class="setting-toggle" onclick="toggleSetting(this)"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // Initialize Socket.IO
    const socket = io();
    
    // Global variables
    let currentDocument = 'sample';
    let analysisMode = false;
    let messageCount = 0;
    
    // Socket events
    socket.emit('join_room', 'pdf_mind');
    
    socket.on('ai_response', function(data) {
        addMessage(data.message, 'ai', data.sources);
        updateStats();
    });
    
    socket.on('analysis_result', function(data) {
        addAnalysisResult(data.analysis, data.type);
    });
    
    // Message functions
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        addMessage(message, 'user');
        input.value = '';
        
        socket.emit('user_message', {
            message: message,
            document: currentDocument,
            analysis_mode: analysisMode,
            agent: 'pdf_mind'
        });
        
        adjustTextareaHeight(input);
    }
    
    function sendQuery(query) {
        document.getElementById('messageInput').value = query;
        sendMessage();
    }
    
    function addMessage(content, sender, sources = null) {
        const container = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let citationHtml = '';
        if (sources && sources.length > 0) {
            citationHtml = '<div class="source-citation">';
            citationHtml += '<div class="citation-header">Sources:</div>';
            sources.forEach((source, index) => {
                citationHtml += `<div>📄 ${source.document}, Page ${source.page}</div>`;
            });
            citationHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-${sender === 'user' ? 'user' : 'brain'}"></i>
            </div>
            <div class="message-content">
                <div class="message-bubble">${content}</div>
                ${citationHtml}
                <div class="message-time">${timeStr}</div>
            </div>
        `;
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        messageCount++;
    }
    
    function addAnalysisResult(analysis, type) {
        const container = document.getElementById('messagesContainer');
        const resultDiv = document.createElement('div');
        resultDiv.className = 'message ai';
        
        const icons = {
            sentiment: 'fas fa-smile',
            keywords: 'fas fa-tags',
            entities: 'fas fa-user-tag',
            topics: 'fas fa-sitemap',
            readability: 'fas fa-eye',
            summary: 'fas fa-compress-alt'
        };
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        resultDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-brain"></i>
            </div>
            <div class="message-content">
                <div class="analysis-result">
                    <div class="analysis-header">
                        <i class="${icons[type] || 'fas fa-chart-bar'}"></i>
                        ${type.charAt(0).toUpperCase() + type.slice(1)} Analysis
                    </div>
                    <div class="analysis-content">${analysis}</div>
                </div>
                <div class="message-time">${timeStr}</div>
            </div>
        `;
        
        container.appendChild(resultDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    // Document functions
    function selectDocument(element, docId) {
        document.querySelectorAll('.document-item').forEach(item => item.classList.remove('active'));
        element.classList.add('active');
        currentDocument = docId;
        
        // Update status
        const statusText = element.querySelector('.doc-name').textContent;
        document.querySelector('.status-indicator span').textContent = `Analyzing: ${statusText}`;
    }
    
    function handleDocumentUpload(event) {
        const files = event.target.files;
        const docsList = document.getElementById('documentsList');
        
        Array.from(files).forEach(file => {
            const docItem = document.createElement('div');
            docItem.className = 'document-item';
            docItem.onclick = () => selectDocument(docItem, file.name);
            
            const fileType = file.type === 'application/pdf' ? 'pdf' : 'alt';
            const fileColor = file.type === 'application/pdf' ? '#ef4444' : '#3b82f6';
            
            docItem.innerHTML = `
                <div class="doc-name">
                    <i class="fas fa-file-${fileType}" style="color: ${fileColor};"></i>
                    ${file.name}
                </div>
                <div class="doc-info">
                    <span>Processing...</span>
                    <span>${(file.size / 1024 / 1024).toFixed(1)} MB</span>
                </div>
            `;
            
            docsList.appendChild(docItem);
            
            // Simulate processing
            setTimeout(() => {
                const info = docItem.querySelector('.doc-info span');
                info.textContent = Math.floor(Math.random() * 200 + 10) + ' pages';
                addMessage(`📄 Successfully uploaded and analyzed: ${file.name}`, 'ai');
            }, 2000);
        });
    }
    
    // Analysis functions
    function runAnalysis(type) {
        const analyses = {
            sentiment: "Overall document sentiment: <span class='highlight-text'>Neutral to Positive (0.65)</span><br>• Methodology sections: Neutral<br>• Results sections: Positive<br>• Conclusion: Highly Positive",
            keywords: "Top keywords identified:<br>• <span class='highlight-text'>Machine Learning</span> (47 occurrences)<br>• <span class='highlight-text'>Neural Networks</span> (32 occurrences)<br>• <span class='highlight-text'>Data Analysis</span> (28 occurrences)",
            entities: "Key entities found:<br>• <span class='highlight-text'>Organizations:</span> MIT, Stanford, Google<br>• <span class='highlight-text'>People:</span> Dr. Smith, Prof. Johnson<br>• <span class='highlight-text'>Technologies:</span> TensorFlow, PyTorch",
            topics: "Main topics discovered:<br>• <span class='highlight-text'>Deep Learning</span> (35%)<br>• <span class='highlight-text'>Computer Vision</span> (25%)<br>• <span class='highlight-text'>Natural Language Processing</span> (20%)",
            readability: "Readability analysis:<br>• <span class='highlight-text'>Flesch Score:</span> 45 (College level)<br>• <span class='highlight-text'>Average sentence length:</span> 18 words<br>• <span class='highlight-text'>Complex words:</span> 15%",
            summary: "Document summary:<br>This research presents a novel approach to <span class='highlight-text'>deep learning architectures</span> with improved performance on computer vision tasks. The methodology combines traditional CNNs with transformer architectures, achieving <span class='highlight-text'>95.3% accuracy</span> on standard benchmarks."
        };
        
        addAnalysisResult(analyses[type], type);
    }
    
    function toggleAnalysisMode() {
        analysisMode = !analysisMode;
        const icon = document.getElementById('analysisIcon');
        
        if (analysisMode) {
            icon.className = 'fas fa-microscope text-yellow-400';
            addMessage('🔬 Advanced analysis mode activated. I\'ll provide deeper insights and more detailed explanations.', 'ai');
        } else {
            icon.className = 'fas fa-microscope';
            addMessage('📊 Standard analysis mode activated. I\'ll provide quick and concise responses.', 'ai');
        }
    }
    
    // Utility functions
    function toggleSetting(toggle) {
        toggle.classList.toggle('active');
    }
    
    function adjustTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }
    
    function exportAnalysis() {
        const messages = document.querySelectorAll('.message');
        let analysisLog = 'PDFMind Document Analysis Export\n';
        analysisLog += '=' . repeat(50) + '\n\n';
        
        messages.forEach(msg => {
            const sender = msg.classList.contains('user') ? 'User' : 'PDFMind';
            const content = msg.querySelector('.message-bubble').textContent;
            const time = msg.querySelector('.message-time').textContent;
            
            analysisLog += `[${time}] ${sender}: ${content}\n`;
            
            const citation = msg.querySelector('.source-citation');
            if (citation) {
                analysisLog += `Sources: ${citation.textContent}\n`;
            }
            
            analysisLog += '\n';
        });
        
        const blob = new Blob([analysisLog], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pdfmind_analysis_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function clearChat() {
        if (confirm('Are you sure you want to clear this analysis session? This action cannot be undone.')) {
            document.getElementById('messagesContainer').innerHTML = '';
            messageCount = 0;
        }
    }
    
    function openAdvancedQuery() {
        const query = prompt('Enter your advanced query:', 'What is the correlation between [concept A] and [concept B] mentioned in the documents?');
        if (query) {
            document.getElementById('messageInput').value = query;
            sendMessage();
        }
    }
    
    function insertCitation() {
        const input = document.getElementById('messageInput');
        input.value += ' [Citation needed]';
        input.focus();
    }
    
    function updateStats() {
        // Update any relevant statistics
        document.querySelector('.status-indicator span').textContent = `Processed ${messageCount} queries`;
    }
    
    // Event listeners
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    document.getElementById('messageInput').addEventListener('input', function() {
        adjustTextareaHeight(this);
    });
    
    // Drag and drop for document upload
    const uploadZone = document.querySelector('.upload-zone');
    
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--pdf-primary)';
        uploadZone.style.background = 'var(--pdf-bg-glass)';
    });
    
    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--pdf-border)';
        uploadZone.style.background = 'transparent';
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--pdf-border)';
        uploadZone.style.background = 'transparent';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('pdfInput').files = files;
            handleDocumentUpload({ target: { files: files } });
        }
    });
    
    // Initialize on page load
    window.addEventListener('load', function() {
        document.getElementById('messageInput').focus();
    });
</script>
{% endblock %}